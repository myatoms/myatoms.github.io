<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Molecule Simulator — Universal 3D (PubChem-backed)</title>
  <script src="https://3Dmol.org/build/3Dmol-min.js"></script>
  <style>
    :root{
      --panel-w:320px; --bg:#000; --panel-bg:#071022; --muted:#9dbadf; --accent:#12a4ff; --ui:#e6eef8;
    }
    html,body{height:100%;margin:0;background:var(--bg);color:var(--ui);font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;}
    #app{display:flex;height:100vh;}
    #controls{width:var(--panel-w);min-width:260px;padding:18px;box-sizing:border-box;background:var(--panel-bg);border-right:1px solid rgba(255,255,255,0.03);overflow:auto;}
    #viewer{flex:1;position:relative;}
    h1{margin:0;font-size:18px;color:var(--accent);}
    label{display:block;margin-top:12px;font-size:13px;color:var(--muted);}
    input[type=text]{width:100%;padding:9px;border-radius:6px;border:1px solid rgba(255,255,255,0.06);background:#071023;color:var(--ui);box-sizing:border-box;margin-top:8px;}
    button{margin-top:12px;padding:9px 12px;border-radius:8px;border:0;cursor:pointer;background:var(--accent);color:#002234;font-weight:600;}
    .toggles{margin-top:12px;display:flex;flex-direction:column;gap:8px;}
    .toggle{display:flex;align-items:center;gap:8px;}
    .small{font-size:12px;color:var(--muted);}
    .notice{margin-top:10px;font-size:12px;color:var(--muted);}
    a{color:var(--accent);text-decoration:none;}
  </style>
</head>
<body>
  <div id="app">
    <div id="controls">
      <h1>Molecule Simulator — Universal 3D</h1>

      <label>Enter name / formula / SMILES / InChI</label>
      <input id="molInput" value="NH3" placeholder="e.g. H2O, ammonia, CCO (ethanol), CC(=O)O (acetic acid)" />

      <div style="display:flex;gap:8px;">
        <button id="confirmBtn">Confirm & Render</button>
        <button id="examplesBtn">Examples</button>
      </div>

      <div class="toggles">
        <div class="toggle"><input id="showLabels" type="checkbox" checked> <label for="showLabels" class="small">Show labels</label></div>
        <div class="toggle"><input id="showBonds" type="checkbox" checked> <label for="showBonds" class="small">Show bonds</label></div>
        <div class="toggle"><input id="showNuclei" type="checkbox" checked> <label for="showNuclei" class="small">Show nuclei (red, semi-transparent)</label></div>
        <div class="toggle"><input id="lowQuality" type="checkbox"> <label for="lowQuality" class="small">Low quality (faster)</label></div>
        <div class="toggle"><input id="showRawPubChem" type="checkbox"> <label for="showRawPubChem" class="small">Show PubChem-provided geometry when available</label></div>
      </div>

      <div class="notice">
        <div class="small">This tool attempts to fetch *real* 3D conformers from PubChem when possible (fast and reliable for almost all small molecules). If PubChem doesn't have a 3D structure, it uses internal idealized geometries for common molecules or a safe fallback layout.</div>
        <div class="small" style="margin-top:8px;">If you need very high-precision QM geometries for unusual molecules, I can embed a curated local database (PDB / XYZ) for those specific compounds on request.</div>
      </div>
    </div>

    <div id="viewer"></div>
  </div>

  <script>
  /*********************
   * Utilities & DB
   *********************/
  const viewer = $3Dmol.createViewer('viewer',{backgroundColor:'black',antialias:true});
  const elementColors = { H:'#FFFFFF', C:'#909090', N:'#3050F8', O:'#FF0D0D', S:'#FFFF30', P:'#FFA500', Cl:'#1FF01F' };
  const covalentRadii = { H:0.31, C:0.76, N:0.71, O:0.66, S:1.05, P:1.07, Cl:1.02 };

  // small internal geometry DB (accurate textbook geometries for common molecules)
  const geometryDB = {
    'NH3': {/* same as previous accurate NH3 geometry */ atoms:[{elem:'N',x:0,y:0,z:0},{elem:'H',x:0.963,y:0.0,z:0.0},{elem:'H',x:-0.321,y:0.935,z:0.0},{elem:'H',x:-0.321,y:-0.935,z:0.0}], bonds:[[0,1],[0,2],[0,3]] },
    'H2O': { atoms:[{elem:'O',x:0,y:0,z:0},{elem:'H',x:0.7586,y:0.5043,z:0},{elem:'H',x:0.7586,y:-0.5043,z:0}], bonds:[[0,1],[0,2]] },
    'CH4': { atoms:[{elem:'C',x:0,y:0,z:0},{elem:'H',x:0.629,y:0.629,z:0.629},{elem:'H',x:0.629,y:-0.629,z:-0.629},{elem:'H',x:-0.629,y:0.629,z:-0.629},{elem:'H',x:-0.629,y:-0.629,z:0.629}], bonds:[[0,1],[0,2],[0,3],[0,4]] }
    // add more if you want
  };

  /*********************
   * PubChem 3D fetch helpers
   *
   * We try a few endpoints in order:
   * 1) compound/name/{name}/record/SDF?record_type=3d
   * 2) compound/cid/{cid}/record/SDF?record_type=3d   (after getting CID)
   * 3) compound/smiles/{smiles}/record/SDF?record_type=3d
   *
   * If a 3D SDF is returned we parse it into the viewer using 3Dmol's SDF parser.
   *********************/
  async function fetchPubChemSDFByName(name){
    const enc = encodeURIComponent(name);
    const urls = [
      `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${enc}/record/SDF?record_type=3d`,
      `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${enc}/SDF?record_type=3d`, // alternate
      `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${enc}/SDF` // fallback
    ];
    for(const u of urls){
      try{
        const res = await fetch(u);
        if(res.ok){
          const txt = await res.text();
          if(txt && txt.trim().length>50 && txt.includes('V2000') || txt.includes('M  END')) return txt;
        }
      }catch(e){ /* ignore and try next */ }
    }
    return null;
  }

  async function fetchCIDByName(name){
    const enc = encodeURIComponent(name);
    const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/name/${enc}/cids/TXT`;
    try{
      const res = await fetch(url);
      if(!res.ok) return null;
      const txt = (await res.text()).trim();
      if(!txt) return null;
      // first CID line
      const first = txt.split(/\s+/)[0];
      return first || null;
    }catch(e){ return null; }
  }

  async function fetchPubChemSDFByCID(cid){
    const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/cid/${cid}/record/SDF?record_type=3d`;
    try{
      const res = await fetch(url);
      if(res.ok){
        const txt = await res.text();
        if(txt && txt.trim().length>50 && (txt.includes('V2000') || txt.includes('M  END'))) return txt;
      }
    }catch(e){}
    return null;
  }

  async function fetchPubChemSDFGeneric(input){
    // try name first
    let sdf = await fetchPubChemSDFByName(input);
    if(sdf) return {sdf,source:'name'};
    // try CID
    const cid = await fetchCIDByName(input);
    if(cid){
      sdf = await fetchPubChemSDFByCID(cid);
      if(sdf) return {sdf,source:'cid',cid};
    }
    // try interpreting input as SMILES
    try {
      // simple heuristic: contains characters typical of SMILES (#=()/\\)
      if(/[=#@\\\/\[\]\(\)]/.test(input) || /[a-z]/.test(input) && !/^\s*[A-Za-z0-9]+\s*$/.test(input)){
        const smiEnc = encodeURIComponent(input);
        const url = `https://pubchem.ncbi.nlm.nih.gov/rest/pug/compound/smiles/${smiEnc}/record/SDF?record_type=3d`;
        const res = await fetch(url);
        if(res.ok){
          const txt = await res.text();
          if(txt && txt.trim().length>50) return {sdf:txt,source:'smiles'};
        }
      }
    } catch(e){}
    return null;
  }

  /*********************
   * Render helpers using 3Dmol.js
   *********************/
  function addNucleiUnderModel(model, opt){
    const showNuclei = document.getElementById('showNuclei').checked;
    if(!showNuclei) return;
    // model.getAtoms() returns array of atoms with x,y,z & elem
    const atoms = model.getAtoms();
    for(const a of atoms){
      // small red translucent sphere under each atom center
      viewer.addSphere({ center:{x:a.x, y:a.y, z:a.z}, radius:0.30, color:'#FF0000', alpha:0.36, clickable:false });
    }
  }

  // generic renderer when we have an SDF string
  function renderSDF(sdfText, opts = {}){
    viewer.clear();
    // add model and style with element-based colors
    const m = viewer.addModel(sdfText,'sdf');
    const lowQ = document.getElementById('lowQuality').checked;
    const showBonds = document.getElementById('showBonds').checked;
    const showLabels = document.getElementById('showLabels').checked;
    // use cartoon-like spheres via setStyle
    viewer.setStyle({}, {sphere:{scale:1.0}}); // sphere for atoms
    if(showBonds){
      // sticks (cylinders) for bonds
      viewer.setStyle({},{stick:{radius: lowQ ? 0.06 : 0.09}});
    } else {
      // no bonds shown (but atoms still shown)
      viewer.setStyle({},{sphere:{scale:1.0}});
    }
    // map element colors where possible
    // 3Dmol auto-colors by element if no color specified; we can override per-atom later if desired
    viewer.zoomTo();
    viewer.render();
    // add nuclei as separate shapes under atoms (so they're visible below atom spheres)
    addNucleiUnderModel(m);
    // optionally add element labels
    if(showLabels){
      const atoms = m.getAtoms();
      for(const a of atoms) viewer.addLabel(a.elem, { position:{x:a.x,y:a.y,z:a.z}, backgroundColor:'rgba(0,0,0,0.6)', fontColor:'#fff', fontSize:12 });
    }
  }

  // fallback renderer for internal geometry objects (atoms array + bonds)
  function renderFromStructure(struct){
    viewer.clear();
    const showLabels = document.getElementById('showLabels').checked;
    const showBonds = document.getElementById('showBonds').checked;
    const lowQ = document.getElementById('lowQuality').checked;
    const showNuc = document.getElementById('showNuclei').checked;

    if(showNuc){
      for(const a of struct.atoms) viewer.addSphere({center:a.pos, radius:0.30, color:'#FF0000', alpha:0.36});
    }
    for(const a of struct.atoms){
      const col = elementColors[a.elem] || '#CCCCCC';
      const baseRad = (covalentRadii[a.elem]||0.8) * 0.26;
      const radius = lowQ ? baseRad*0.85 : baseRad;
      viewer.addSphere({center:a.pos, radius:radius, color:col});
      if(showLabels) viewer.addLabel(a.elem, {position:a.pos, backgroundColor:'rgba(0,0,0,0.6)', fontColor:'#fff', fontSize:12});
    }
    if(showBonds){
      const cylR = lowQ ? 0.06 : 0.09;
      for(const b of struct.bonds){
        const a = struct.atoms[b.a], c = struct.atoms[b.b];
        viewer.addCylinder({start:a.pos, end:c.pos, radius:cylR, color:'#cfcfcf'});
      }
    }
    viewer.zoomTo();
    viewer.render();
  }

  /*********************
   * Build helpers for geometryDB -> structure format used by renderer
   *********************/
  function buildStructFromDB(key, entry){
    if(!entry) return null;
    const atoms = entry.atoms.map(a => ({ elem: a.elem, pos: { x:(a.x||0), y:(a.y||0), z:(a.z||0) } }));
    const bonds = [];
    if(Array.isArray(entry.bonds) && entry.bonds.length>0){
      for(const b of entry.bonds) bonds.push({a:b[0], b:b[1]});
    } else {
      // auto-detect bonds by distance
      for(let i=0;i<atoms.length;i++){
        for(let j=i+1;j<atoms.length;j++){
          const ri = covalentRadii[atoms[i].elem] || 0.9;
          const rj = covalentRadii[atoms[j].elem] || 0.9;
          if(Math.hypot(atoms[i].pos.x-atoms[j].pos.x, atoms[i].pos.y-atoms[j].pos.y, atoms[i].pos.z-atoms[j].pos.z) < (ri + rj)*1.25){
            bonds.push({a:i,b:j});
          }
        }
      }
    }
    return { atoms, bonds };
  }

  /*********************
   * Main UI workflow
   *********************/
  async function handleRender(input){
    input = (input||'').trim();
    if(!input){ alert('Please type a molecule name, formula, or SMILES'); return; }

    // 1) Try local exact DB first (fast)
    const standardized = input.replace(/\s+/g,'');
    if(geometryDB[standardized]){
      const struct = buildStructFromDB(standardized, geometryDB[standardized]);
      renderFromStructure(struct);
      return;
    }
    // 2) Try PubChem (best chance to get realistic 3D)
    setStatus('looking up PubChem 3D conformer...');
    try{
      const result = await fetchPubChemSDFGeneric(input);
      if(result && result.sdf){
        // very large SDFs (macromolecules) may be slow — detect size and warn
        if(result.sdf.length > 500000){
          if(!confirm('PubChem returned a very large structure (likely a macromolecule). Rendering may be slow — continue?')) {
            setStatus('render cancelled by user for large structure');
            return;
          }
        }
        // render SDF via 3Dmol
        renderSDF(result.sdf);
        setStatus('rendered PubChem geometry (' + (result.source || 'pubchem') + (result.cid ? ' CID:'+result.cid : '') + ')');
        return;
      }
    }catch(e){
      console.warn('PubChem fetch failed', e);
    }

    // 3) fallback: try to interpret input as formula and build safe chain/ring
    setStatus('PubChem not found — using fallback generator');
    const fallback = fallbackStructureFromFormula(standardized);
    renderFromStructure(fallback);
    setStatus('rendered fallback structure (approximate)');
  }

  function setStatus(txt){
    // lightweight status in document title (non-intrusive)
    document.title = `Molecule Simulator — ${txt}`;
    console.log(txt);
  }

  // Simple fallback generator: expand formula into atom list and place along chain or ring
  function fallbackStructureFromFormula(formula){
    // e.g. H2O -> ['H','H','O']
    const re = /([A-Z][a-z]?)(\d*)/g;
    let m, list = [];
    while((m=re.exec(formula))!==null){
      const el = m[1];
      const cnt = m[2] ? parseInt(m[2]) : 1;
      for(let i=0;i<cnt;i++) list.push(el);
    }
    if(list.length === 0) list = [formula]; // last resort
    const atoms = list.map((el,i) => ({ elem:el, pos:{ x:(i - (list.length-1)/2)*1.45, y: 0, z: (i%2)*0.2 }}));
    const bonds = [];
    for(let i=0;i<list.length-1;i++) bonds.push({a:i,b:i+1});
    return { atoms, bonds };
  }

  // Wire UI
  document.getElementById('confirmBtn').addEventListener('click', () => {
    const raw = document.getElementById('molInput').value;
    handleRender(raw);
  });
  document.getElementById('examplesBtn').addEventListener('click', () => {
    const ex = ['NH3','H2O','CH4','CO2','C6H6','CH3OH','C2H6','C2H4','C2H2','H2','O2','N2'];
    const choice = prompt('Type example (or paste SMILES):\n' + ex.join(', '), 'NH3');
    if(choice) document.getElementById('molInput').value = choice;
  });

  // re-render toggles quickly on change (if a model is present we re-render from last input)
  ['showLabels','showBonds','showNuclei','lowQuality','showRawPubChem'].forEach(id=>{
    document.getElementById(id).addEventListener('change', () => {
      // attempt to re-render current input
      const raw = document.getElementById('molInput').value;
      if(raw && raw.trim().length) handleRender(raw);
    });
  });

  // Initial render
  setTimeout(()=>{ handleRender(document.getElementById('molInput').value); }, 120);
  window.addEventListener('resize', ()=>{ viewer.setSize(document.getElementById('viewer').clientWidth, document.getElementById('viewer').clientHeight); viewer.render(); });
  </script>
</body>
</html>
