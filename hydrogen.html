<script>
let viewer = $3Dmol.createViewer("viewer", {backgroundColor:"black"});
let electronShape = null;
let electronLabel = null;
let electronTheta = 0;

let quarks = [];
let quarkLabels = [];

function addOrbit(radius) {
    const segments = 50;
    const points = [];
    for (let i=0;i<=segments;i++){
        let t=2*Math.PI*(i/segments);
        points.push({x:radius*Math.cos(t),y:radius*Math.sin(t),z:0});
    }
    return viewer.addCurve({points,color:"#ffffff",linewidth:3});
}

function buildStatic(){
    viewer.removeAllShapes();
    viewer.removeAllLabels();

    // Proton
    viewer.addSphere({center:{x:0,y:0,z:0}, radius:0.3, color:"red", alpha:0.6, wireframe:true});

    // Orbit
    if(document.getElementById("showOrbit").checked){
        addOrbit(1.2);
    }

    // Quarks
    quarks = [];
    quarkLabels = [];
    if(document.getElementById("showQuarks").checked){
        const qColors = ["#ff0000","#00ff00","#0000ff"];
        const qPositions = [{x:0.1,y:0.1,z:0},{x:-0.1,y:0.1,z:0},{x:0,y:-0.1,z:0}];
        for(let i=0;i<3;i++){
            quarks.push({...qPositions[i], color:qColors[i]});
            viewer.addSphere({center:qPositions[i], radius:0.1, color:qColors[i], alpha:0.8});
            if(document.getElementById("showLabels").checked){
                quarkLabels.push(viewer.addLabel(
                    qColors[i]!="#0000ff"?"Up Quark":"Down Quark",
                    {position:qPositions[i], backgroundColor:qColors[i], fontColor:"white", fontSize:10}
                ));
            }
        }
    }

    // Proton label
    if(document.getElementById("showLabels").checked){
        viewer.addLabel("Proton",{position:{x:0,y:0.5,z:0}, backgroundColor:"red", fontColor:"white", fontSize:14});
    }
}

function updateElectron(){
    if(electronShape) viewer.removeShape(electronShape);
    if(electronLabel) viewer.removeLabel(electronLabel);

    const ex = 1.2*Math.cos(electronTheta);
    const ey = 1.2*Math.sin(electronTheta);

    electronShape = viewer.addSphere({center:{x:ex,y:ey,z:0}, radius:0.15, color:"yellow"});
    if(document.getElementById("showLabels").checked){
        electronLabel = viewer.addLabel("Electron",{position:{x:ex+0.3,y:ey+0.3,z:0}, backgroundColor:"yellow", fontColor:"black", fontSize:12});
    }
}

function animate(){
    electronTheta += 0.03;
    updateElectron();

    // Move quarks
    if(document.getElementById("showQuarks").checked){
        for(let i=0;i<quarks.length;i++){
            quarks[i].x += (Math.random()-0.5)*0.02;
            quarks[i].y += (Math.random()-0.5)*0.02;
            quarks[i].z += (Math.random()-0.5)*0.02;
            // Remove old and re-add
            viewer.removeShape(i+1); // 0=proton, so i+1 works
            viewer.addSphere({center:{x:quarks[i].x,y:quarks[i].y,z:quarks[i].z}, radius:0.1, color:quarks[i].color, alpha:0.8});
            if(quarkLabels[i]) quarkLabels[i].setPosition({x:quarks[i].x,y:quarks[i].y,z:quarks[i].z});
        }
    }

    viewer.render();
    requestAnimationFrame(animate);
}

// Event listeners
["showLabels","showOrbit","showQuarks"].forEach(id=>{
    document.getElementById(id).addEventListener("change", buildStatic);
});

buildStatic();
viewer.zoomTo();
animate();
</script>
